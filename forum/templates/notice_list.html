
{% extends "./base.html" %}
{% load static %}
{%block css%}
<link rel="stylesheet" type="text/css" href="/static/css/userpage.css">
<!-- 引用外部 JavaScript 文件 -->
<script>
function openModal() {
    document.getElementById("change_avatar").style.display = "block";
}

function closeModal() {
    document.getElementById("change_avatar").style.display = "none";
}

window.onclick = function(event) {
    var modal = document.getElementById("change_avatar");
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
function previewAvatar(input) {
    const preview = document.getElementById("avatar-preview-img");
    const file = input.files[0];
    if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function (e) {
            preview.src = e.target.result;  // 更新预览图片的 src
        };
        reader.readAsDataURL(file);
    }
}
function updateAvatar() {
    const formData = new FormData(document.getElementById("avatar-form"));
    fetch("{% url 'update_avatar' %}", {  // 使用新视图的 URL
        method: "POST",
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken,  // 添加 CSRF Token
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("服务器响应非 2xx 状态");
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert("头像更新成功！");
            location.reload();  // 重新加载页面以更新头像显示
        } else {
            alert("更新头像失败，请重试。");
        }
    })
    .catch(error => {
        console.error("更新头像时出错：", error);
        alert("更新头像时出错，请检查服务器日志。");
    });
}
</script>

{%endblock%}
{%block announcement%}
{%endblock%}
{%block subnav%}
{%endblock%}

{%block content%}
{% if not user.is_authenticated %}
请先登录<a href="{% url 'user_login' %}" hidefocus="true" title="登陆">登陆</a>
还没有账号？<a href="{% url 'user_register' %}" hidefocus="true" title="注册">点这里注册</a>
{%else%}
<img src="{{user.avatar.url}}" alt="avatar" class ="avatar-container rounded-circle" id="user-avatar" title="更改头像" onclick="openModal()"> 
<a href="{% url 'delete_account'%}" hidefocus = "true" title="delete_account">注销账户</a>
<a href="{% url 'user_logout'%}" hidefocus="true" title="logout">退出登录</a>

{% load static %}


{% load static %}

<!-- 模态窗口 -->
<div id="change_avatar" class="modal">
    <div class="modal-content">
        <!-- 模态头部 -->
        <div class="modal-header">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>更改头像</h2>
        </div>
        <!-- 模态主体内容 -->
        <div class="modal-body">
            <p>在这里上传您的新头像:</p>
            <!-- 显示用户的头像，如果用户没有头像，显示默认头像 -->
            <div class="avatar-preview">
                <img id="avatar-preview-img" src="{{ user.avatar.url|default:'default-avatar.jpg' }}" alt="预览头像" style="width: 100px; height: 100px; border-radius: 50%;">
            </div>

            <!-- 上传头像表单 -->
            <form id="avatar-form" action="{% url 'update_avatar' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" id="avatar-input" name="avatar" accept="image/*" required onchange="previewAvatar(this)">
                <button type="submit">上传</button>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal()">取消</button>
        </div>
    </div>
</div>



{%endif%}
{%endblock%}

{%block pagefoot%}
{%endblock%}


